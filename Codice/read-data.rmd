---
title: "Read challenge data (NB: Work in progress)"
output: html_notebook
---

Offline:
```{r}
library(readr)

# polish data


month_data <- read_delim(file = "../export_giugno_15min.csv", delim = ";")
```

dividere i dati per lotto
```{r}
library(tidyverse)

TENTATIVI <- 100

lotti <- list() # il lotto 1 sarà in posizione 1 ecc

for (i in 1:TENTATIVI) {
  # seleziona le colonne del lotto i

  celle <- list() # lista per le celle
  data <- month_data %>% select(Date, starts_with(paste("Melinda ipogeo_Lotto", i)))
  # esempio data: tutte le variabili che iniziano con "Melinda ipogeo_Lotto 1"

  # rinomina le colonne
  names(data) <- gsub(pattern = ".*Lotto ._", replacement = "", x = names(data))

  if (ncol(data) == 1) { # se sono finiti i lotti, quindi c'è solo la data
    break # esci dal ciclo
  } else {

    # ora dividiamo anche le celle

    # prima prendiamo le colonne comuni a tutte le celle, filtrando quindi i quadri specifici e le variabili delle celle
    colonne_comuni <- data %>%
      select(-starts_with("Cella")) %>%
      select(-starts_with("Quadro Celle"))

    # non sapendo a priori il numero delle celle, e dato che hanno i nomi in progressivo da un lotto all'altro, si va a tentativi
    for (j in 1:TENTATIVI) {

      # selezioniamo i dati della cella corrispondente
      cella <- data %>% select(starts_with(paste0("Cella ", j, "_")))

      if (ncol(cella) == 0) { # nessun match
        next # continua
      } else {
        # selezioniamo i quadri della cella corrispondente
        quadri_celle <- data %>% select(matches(paste0("Quadro Celle ", j, "-.*")), matches(paste0("Quadro Celle ?-", j, ".*")))
        # uniamo i dati della cella e la inseriamo nella lista delle celle
        celle <- append(celle, list(cbind(colonne_comuni, quadri_celle, cella)))
      }
    }
    lotti <- append(lotti, list(celle)) # aggiungi l'insieme di celle alla lista dei lotti
  }
}

```
Se ha avuto successo, meglio liberare i dati di prima che non servono piu'
```{r}
rm(celle, cella, colonne_comuni, data, i, j, month_data, quadri_celle)
```
Se vogliamo un csv per ogni cella, cosi' da semplificare il training
```{r}
library(readr)
# percorso base dove tenere i csv
path <- "./CSV/"
i <- 1 # importante per il numero di cella. Si può ricavare anche dai dati, ma così è più veloce. Possiamo farlo perchè le celle vanno in numero progressivo anche cambiando lotto

# spacchetta le celle a partire dalla struttura dei lotti
celle <- unlist(lotti, recursive = FALSE)

for (cella in celle) {
  write_csv(x = cella, file = paste0(path, "Cella_", i,".csv")) # TODO: da modificare
  i <- i + 1
}
# rimuove i file inutili
rm(cella, i, path)
```
